---
import MainLayout from "@/layouts/MainLayout.astro";
import Icon from "@/components/ui/icons/Icon.astro";
import PrimaryCTA from "@/components/ui/buttons/PrimaryCTA.astro";
import SecondaryCTA from "@/components/ui/buttons/SecondaryCTA.astro";

// Get the token from URL params
const token = Astro.url.searchParams.get("token");
---

<MainLayout title="Confirmer l'Email - Călărași Warriors">
    <div class="mx-auto max-w-2xl px-4 py-16 text-center sm:px-6 lg:px-8">
        <div class="mb-8">
            <div
                class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-yellow-100 dark:bg-yellow-900"
            >
                <Icon
                    name="envelope"
                    class="h-8 w-8 text-yellow-600 dark:text-yellow-400"
                />
            </div>
        </div>

        <div id="confirmation-content">
            {
                token ? (
                    <div>
                        <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl dark:text-white">
                            Confirmation de l'email
                        </h1>
                        <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">
                            Traitement de la confirmation de votre email...
                        </p>
                        <div class="mt-6">
                            <div class="inline-flex items-center rounded-md bg-gray-100 px-4 py-2 text-sm font-medium text-gray-500 dark:bg-gray-800 dark:text-gray-400">
                                <svg
                                    class="mr-3 -ml-1 h-5 w-5 animate-spin text-gray-500 dark:text-gray-400"
                                    xmlns="http://www.w3.org/2000/svg"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                >
                                    <circle
                                        class="opacity-25"
                                        cx="12"
                                        cy="12"
                                        r="10"
                                        stroke="currentColor"
                                        stroke-width="4"
                                    />
                                    <path
                                        class="opacity-75"
                                        fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                                    />
                                </svg>
                                Vérification du token...
                            </div>
                        </div>
                    </div>
                ) : (
                    <div>
                        <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl dark:text-white">
                            Lien invalide
                        </h1>
                        <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">
                            Le lien de confirmation est invalide ou manquant.
                        </p>
                        <div class="mt-8 flex flex-col gap-4 sm:flex-row sm:justify-center">
                            <PrimaryCTA
                                url="/fr/contact"
                                title="Aller au Contact"
                            />
                            <SecondaryCTA url="/fr/" title="Accueil" />
                        </div>
                    </div>
                )
            }
        </div>

        <div id="success-content" class="hidden">
            <div class="mb-8">
                <div
                    class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-green-100 dark:bg-green-900"
                >
                    <Icon
                        name="check"
                        class="h-8 w-8 text-green-600 dark:text-green-400"
                    />
                </div>
            </div>
            <h1
                class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl dark:text-white"
            >
                Email confirmé avec succès !
            </h1>
            <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">
                Merci d'avoir confirmé votre adresse email. Votre message a été
                envoyé avec succès et nous vous répondrons dans les plus brefs
                délais.
            </p>
            <div class="mt-8 flex flex-col gap-4 sm:flex-row sm:justify-center">
                <PrimaryCTA
                    url="/fr/contact"
                    title="Envoyer un autre message"
                />
                <SecondaryCTA url="/fr/" title="Accueil" />
            </div>
        </div>

        <div id="error-content" class="hidden">
            <div class="mb-8">
                <div
                    class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-red-100 dark:bg-red-900"
                >
                    <Icon
                        name="xCircle"
                        class="h-8 w-8 text-red-600 dark:text-red-400"
                    />
                </div>
            </div>
            <h1
                class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl dark:text-white"
            >
                Erreur de confirmation
            </h1>
            <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">
                <span id="error-message"
                    >Une erreur s'est produite lors de la confirmation de
                    l'email.</span
                >
            </p>
            <div class="mt-8 flex flex-col gap-4 sm:flex-row sm:justify-center">
                <PrimaryCTA url="/fr/contact" title="Réessayer" />
                <SecondaryCTA url="/fr/" title="Accueil" />
            </div>
        </div>
    </div>
</MainLayout>

<script>
    // Handle email confirmation
    const token = new URLSearchParams(window.location.search).get("token");

    if (token) {
        confirmEmail(token);
    }

    async function confirmEmail(token: string) {
        try {
            const response = await fetch(`/api/confirm-email?token=${token}`, {
                method: "GET",
            });

            const data = await response.json();

            // Hide the confirmation content
            const confirmationContent = document.getElementById(
                "confirmation-content",
            );
            if (confirmationContent) {
                confirmationContent.classList.add("hidden");
            }

            if (data.ok) {
                // Show success content
                const successContent =
                    document.getElementById("success-content");
                if (successContent) {
                    successContent.classList.remove("hidden");
                }
            } else {
                // Show error content
                const errorContent = document.getElementById("error-content");
                if (errorContent) {
                    errorContent.classList.remove("hidden");
                }
                const errorMessage = document.getElementById("error-message");
                if (errorMessage) {
                    errorMessage.textContent =
                        data.error ||
                        "Une erreur s'est produite lors de la confirmation de l'email.";
                }
            }
        } catch (error) {
            console.error("Error confirming email:", error);

            // Hide the confirmation content
            const confirmationContent = document.getElementById(
                "confirmation-content",
            );
            if (confirmationContent) {
                confirmationContent.classList.add("hidden");
            }

            // Show error content
            const errorContent = document.getElementById("error-content");
            if (errorContent) {
                errorContent.classList.remove("hidden");
            }
            const errorMessage = document.getElementById("error-message");
            if (errorMessage) {
                errorMessage.textContent =
                    "Une erreur réseau s'est produite. Veuillez réessayer.";
            }
        }
    }
</script>
